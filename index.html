<!DOCTYPE html>
<html lang="es" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>XLSX_Reporter</title>
  <meta name="theme-color" content="#f8fafc">
  <meta name="mobile-web-app-capable" content="yes">

  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 256 256'><text y='200' font-size='200'>游늵</text></svg>">

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">
</head>

<body>

  <div class="drag-overlay" id="dragOverlay">
    <div style="text-align: center;">
      <i class="ph ph-file-arrow-up" style="font-size: 48px;"></i>
      <p>Suelta el archivo aqu칤 para abrirlo</p>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <div class="modal-overlay" id="sheetModal">
    <div class="modal-card">
      <h3 style="margin:0; font-size:16px;">Seleccionar Hoja</h3>
      <p style="margin:0; font-size:13px; color:var(--text-muted);">El archivo contiene varias hojas. Selecciona cu치l
        deseas cargar:</p>
      <div class="sheet-list" id="sheetList"></div>
      <button class="btn" style="align-self: flex-end;" id="btnCloseSheetModal">Cancelar</button>
    </div>
  </div>

  <div class="modal-overlay" id="exportModal">
    <div class="modal-card">
      <h3 style="margin:0; font-size:16px;">Confirmar Datos del Reporte</h3>
      <p style="margin:0; font-size:13px; color:var(--text-muted);">Verifica la informaci칩n antes de generar el archivo.
      </p>

      <div style="display:flex; flex-direction:column; gap:12px; margin-top:10px;">
        <div>
          <label style="font-size:11px; font-weight:700; color:var(--text-muted); display:block; margin-bottom:4px; text-transform:uppercase;">T칤tulo
            del Documento</label>
          <input type="text" class="form-input" id="confirmTitle" placeholder="T칤tulo del reporte">
        </div>
        <div>
          <label style="font-size:11px; font-weight:700; color:var(--text-muted); display:block; margin-bottom:4px; text-transform:uppercase;">Autor</label>
          <input type="text" class="form-input" id="confirmAuthor" placeholder="Nombre del autor">
        </div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:20px;">
        <button class="btn" id="btnCancelExport">Cancelar</button>
        <button class="btn btn-primary" id="btnConfirmExport">
          <i class="ph ph-check"></i> Confirmar y Exportar
        </button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="structureModal">
    <div class="modal-card" style="width: 800px; max-width: 95%;">
      <div class="modal-header">
        <h3 class="modal-title">Definir Estructura de Datos</h3>
      </div>
      <div class="modal-body" style="padding: 16px;">
        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 12px;">
          1. Haz <strong>clic en la fila</strong> que contiene los t칤tulos de las columnas (Encabezado).<br>
          2. (Opcional) Indica cu치ntas filas ignorar al final (totales, notas al pie).
        </p>

        <div style="border: 1px solid var(--border); border-radius: 6px; overflow: auto; max-height: 400px; margin-bottom: 16px; background: var(--bg-body);">
          <table id="previewTable" style="width: 100%; border-collapse: collapse;">
          </table>
        </div>

        <div style="display: flex; gap: 16px; align-items: flex-end; justify-content: space-between; border-top: 1px solid var(--border); padding-top: 16px;">
          <div style="display: flex; gap: 10px; align-items: center;">
            <div>
              <label style="font-size: 11px; font-weight: 700; display: block; margin-bottom: 4px;">FILAS A OMITIR AL FINAL</label>
              <input type="number" id="footerSkipCount" class="form-input" value="0" min="0" style="width: 80px;">
            </div>
            <div style="font-size: 12px; color: var(--text-muted);">
              Fila Encabezado: <strong id="selectedHeaderIndexDisplay" style="color: var(--primary);">Auto (1)</strong>
            </div>
          </div>

          <div style="display: flex; gap: 8px;">
            <button class="btn" id="btnCancelStructure">Cancelar</button>
            <button class="btn btn-primary" id="btnConfirmStructure">
              <i class="ph ph-check"></i> Procesar Datos
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="columnContextMenu" class="dropdown" style="width: 280px;"></div>

  <div class="app-wrapper">

    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls, .csv" multiple>

    <header class="app-header premium-header">

      <div class="header-left">
        <div class="report-meta-premium">
          <input type="text" id="reportTitle" class="title-input-premium" value="" placeholder="Nombre del Reporte" autocomplete="on">
          <div class="author-wrapper-premium">
            <i class="ph ph-pen-nib"></i>
            <span>Por:</span>
            <input type="text" id="reportAuthor" class="author-input-premium" value="" placeholder="Escribe tu nombre..." autocomplete="on">
          </div>
        </div>
      </div>

      <div class="header-right toolbar-actions">

        <div class="search-premium">
          <i class="ph ph-magnifying-glass"></i>
          <input type="text" id="globalSearch" class="form-input search-input" placeholder="Buscar en datos..." disabled>
        </div>

        <div style="position:relative">
          <button class="btn btn-ghost" id="btnColumns" onclick="app.toggleMenu('colMenu')" title="Configurar Columnas">
            <i class="ph ph-columns"></i>
          </button>
          <div id="colMenu" class="dropdown" style="right:0; top:55px; width:220px; padding:8px;">
            <div style="padding:4px 8px; border-bottom:1px solid var(--border); margin-bottom:4px;">
              <input type="text" class="form-input form-input-sm" placeholder="Buscar columna..." oninput="app.filterColumnList(this.value)">
            </div>
            <div class="col-list-wrapper" id="colListContainer"></div>
            <div style="display:flex; justify-content:space-between; margin-top:8px; padding-top:8px; border-top:1px solid var(--border);">
              <button class="btn btn-sm" onclick="app.toggleAllColumns(true)">Todas</button>
              <button class="btn btn-sm" onclick="app.toggleAllColumns(false)">Ninguna</button>
            </div>
          </div>
        </div>

        <div class="input-group" style="width: 140px;">
  <i class="ph ph-rows"></i>
  <select id="densitySelect" class="form-select" style="padding-left: 32px; font-weight: 600; cursor: pointer;">
    <option value="normal">Normal</option>
    <option value="compact">Compacta</option>
    <option value="relaxed">Relajada</option>
  </select>
</div>

        <button class="btn btn-ghost danger-hover" id="btnResetPrefs" title="Restaurar configuraci칩n visual">
          <i class="ph ph-arrow-counter-clockwise"></i>
        </button>

        <button class="btn btn-ghost" onclick="app.toggleTheme()" title="Cambiar Tema Dark/Light">
          <i class="ph ph-moon" id="themeIcon"></i>
        </button>

        <div style="position:relative">
          <button class="btn btn-gradient" id="btnExport" onclick="app.toggleMenu('exportMenu')">
            <span>Exportar</span> <i class="ph ph-caret-down"></i>
          </button>
          <div id="exportMenu" class="dropdown" style="right:0; top:55px; width:200px; padding:8px;">
            <div class="dropdown-item" onclick="app.exportTo('xlsx')">
              <i class="ph ph-file-xls" style="color:var(--success)"></i> Excel (.xlsx)
            </div>
            <div class="dropdown-item" onclick="app.openCsvMapper()">
              <i class="ph ph-file-csv" style="color:#f59e0b"></i> CSV AlmacenPT
            </div>
            <div class="dropdown-item" onclick="app.exportTo('html')">
              <i class="ph ph-browser" style="color:var(--primary)"></i> HTML Interactivo
            </div>
            <div class="dropdown-item" onclick="app.exportTo('pdf')">
              <i class="ph ph-file-pdf" style="color:var(--danger)"></i> PDF Est치tico
            </div>
          </div>
        </div>

        <div class="brand-right">
          <i class="ph ph-grid-four"></i>
          <span>XLSX Filer</span>
        </div>

      </div>
    </header>

    <div id="filterSummaryBar" class="active-filters-bar hidden"></div>

    <main class="data-container">

      <div id="loadingState" class="empty-state hidden">
        <div class="loader"></div>
        <p style="margin-top: 15px;">Procesando archivo...</p>
      </div>

      <div id="emptyState" class="empty-state">
        <div style="background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(14,165,233,0.1)); padding: 24px; border-radius: 50%; margin-bottom: 24px;">
          <i class="ph ph-file-csv empty-icon" style="margin: 0; background: linear-gradient(135deg, #10b981, #0ea5e9); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 72px;"></i>
        </div>
        <h2 style="font-size: 24px; font-weight: 800; margin-bottom: 8px; color: var(--text-main);">Bienvenido a XLSX Filer</h2>
        <p style="max-width: 400px; line-height: 1.5; margin-bottom: 24px;">Arrastra y suelta tu archivo Excel (.xlsx) o CSV aqu칤, o haz click al boton para seleccionar en el explorador de archivos.</p>
        <button class="btn btn-gradient" onclick="document.getElementById('fileInput').click()" style="padding: 0 30px; height: 48px; font-size: 15px;">
          <i class="ph ph-upload-simple"></i> Cargar Archivo
        </button>
      </div>

      <div id="tableWrapper" class="table-wrapper hidden">
        <table id="mainTable">
          <thead id="tHead"></thead>
          <tbody id="tBody"></tbody>
          <tfoot id="tFoot"></tfoot>
        </table>
      </div>

    </main>

    <footer class="footer-bar hidden" id="appFooter">
      <div id="statusMsg">0 registros</div>
      <div class="pagination">
        <span class="page-info">P치gina <strong id="currPage">1</strong> de <strong id="totalPages">1</strong></span>
        <button class="btn btn-icon" id="btnPrev" disabled><i class="ph ph-caret-left"></i></button>
        <button class="btn btn-icon" id="btnNext" disabled><i class="ph ph-caret-right"></i></button>
        <select id="pageSize" class="form-input" style="width: auto; padding: 4px 8px;">
          <option value="100">100 / p치g</option>
          <option value="500">500 / p치g</option>
          <option value="1000">1000 / p치g</option>
        </select>
      </div>
    </footer>
  </div>

  <div class="modal-overlay" id="csvMapModal">
    <div class="modal-card" style="width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">CSV AlmacenPT</h3>
      </div>
      <div class="modal-body" style="padding: 20px; gap: 16px;">
        <p style="font-size:13px; color:var(--text-muted);">Asigna las columnas de tu archivo a los campos requeridos.</p>

        <div class="mapping-row">
          <label class="mapping-label">1. LOCALIDAD</label>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <select id="mapLocalidad" class="form-select"></select>
            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="chkManualLocalidad" onchange="app.toggleLocalidadInput()">
              <label for="chkManualLocalidad" style="font-size:12px; cursor:pointer">No existe en archivo (Usar valor fijo)</label>
            </div>
            <input type="text" id="inputManualLocalidad" class="form-input hidden" placeholder="Escribe la localidad (ej: LIMA)">
          </div>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">2. SCAN_CODE</label>
          <select id="mapScanCode" class="form-select"></select>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">3. PRODUCTO X</label>
          <select id="mapProducto" class="form-select"></select>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">4. PEDIDO</label>
          <select id="mapPedido" class="form-select"></select>
        </div>

        <div class="mapping-row">
          <label class="mapping-label">5. ORDEN DE COMPRA</label>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <select id="mapOrdenCompra" class="form-select"></select>

            <div style="display:flex; align-items:center; gap:8px;">
              <input type="checkbox" id="chkAutoOC" onchange="app.toggleAutoOC()">
              <label for="chkAutoOC" style="font-size:12px; cursor:pointer">Generar ID Autom치tico (Fecha_Hora)</label>
            </div>

            <input type="text" id="previewAutoOC" class="form-input hidden" disabled style="background:var(--bg-body); color:var(--text-muted); font-family:monospace;">
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
            <button class="btn" onclick="document.getElementById('csvMapModal').classList.remove('active')">Cancelar</button>
            <button class="btn btn-primary" onclick="app.generateCustomCSV()">
              <i class="ph ph-download-simple"></i> Descargar CSV
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script src="script.js"></script>

</body>

</html>
